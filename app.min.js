var userId=(new Date).getTime(),fb,startData={map:{lat:-34.397,lng:150.644,zoom:5,mapTypeId:google.maps.MapTypeId.ROADMAP},inControl:userId};window.location.hash?fb=new Firebase("https://mapstash.firebaseio.com/").child(window.location.hash.replace("#","")):(fb=new Firebase("https://mapstash.firebaseio.com/").push(startData),window.location.hash=fb.name()),fb.once("value",function(a){function b(a,b){var c=f.indexOf(a);c>=0&&(e[c].setMap(null),e.splice(c,1),f.splice(c,1)),b&&b.remove()}function c(a,c){var d=new google.maps.Marker({position:a,map:map});c||(c=fb.child("markers").push({lat:a.lat(),lng:a.lng()})),e.push(d),f.push(c.name()),google.maps.event.addListener(d,"click",function(){b(c.name(),c)})}var d=a.val()||startData;window.map=new google.maps.Map(document.getElementById("map"),{zoom:d.map.zoom,center:new google.maps.LatLng(d.map.lat,d.map.lng),mapTypeId:d.map.mapTypeId,streetViewControl:!1});var e=[],f=[];fb.child("markers").on("child_added",function(a){if(e.indexOf(a.name())<0){var b=a.val();c(new google.maps.LatLng(b.lat,b.lng),a.ref())}}),fb.child("markers").on("child_removed",function(a){b(a.name())});var g=function(){currentData={lat:map.getCenter().lat(),lng:map.getCenter().lng(),zoom:map.getZoom(),mapTypeId:map.getMapTypeId()},fb.update({map:currentData,inControl:userId})};google.maps.event.addListener(map,"click",function(a){c(a.latLng)});var h=[],i=["center_changed","zoom_changed","maptypeid_changed"],j=function(){i.forEach(function(a){h.push(google.maps.event.addListener(map,a,g))})},k=function(){h.forEach(function(a){google.maps.event.removeListener(a)}),h=[]};j(),fb.on("value",function(a){var b=a.val();b&&b.inControl!==userId&&(k(),map.setCenter(new google.maps.LatLng(b.map.lat,b.map.lng)),map.setZoom(b.map.zoom),map.setMapTypeId(b.map.mapTypeId),j())})});